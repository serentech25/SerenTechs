#define BLYNK_TEMPLATE_ID "TMPL6L4lN0_Gx"
#define BLYNK_TEMPLATE_NAME "AromaSync"
#define BLYNK_AUTH_TOKEN "M5voMxFgt08EStJ2GcyzOw0x3NX1nQDY"

// Libraries
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Adafruit_NeoPixel.h>
#include <DHT.h>

// --- WIFI CREDENTIALS ---
char ssid[] = "serentech";
char pass[] = "champion";

// --- DHT11 CONFIGURATION ---
#define DHTPIN 14
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// --- WATER SENSOR CONFIGURATION ---
#define SIGNAL_PIN 35
#define SIGNAL_PIN2 34
int water_value = 0;
int water_value2 = 0;

// --- OTHER PIN DEFINITIONS ---
#define RELAY1_PIN 16
#define RELAY2_PIN 17
#define RELAY3_PIN 18
#define BUTTON_PIN 27
#define BUZZER_PIN 25

// --- LED STRIP CONFIGURATION ---
#define LED_PIN    19
#define LED_COUNT  92
#define BRIGHTNESS 30
Adafruit_NeoPixel strip(LED_COUNT, LED_PIN, NEO_GRB + NEO_KHZ800);

// --- LCD CONFIGURATION ---
LiquidCrystal_I2C lcd(0x27, 16, 2);

// State variables
int relayState = 0;  // Start at 0 (Off)
bool lastButtonState = HIGH;

// Button timing
unsigned long buttonPressStart = 0;
bool buttonPressed = false;

// Sensor data variables
float tempDeg = 0.0;
int hum = 0;
unsigned long lastDHTRead = 0;

// LED timing
unsigned long lastColorChange = 0;
bool isOrange = true;

// --- VARIABLES FOR ZeRGBa ---
bool manualColorMode = false; // Flag for using ZeRGBa or not
int r = 0, g = 0, b = 0;      // Store ZeRGBa color

// LCD timing
unsigned long lastLCDUpdate = 0;
bool needsLCDUpdate = true;

// Blynk timing
unsigned long lastBlynkSend = 0;

// Auto mode variables
bool autoMode = false;
unsigned long manualOverrideStart = 0;
const unsigned long MANUAL_OVERRIDE_DURATION = 30 * 60 * 1000;

// Buzzer timing
unsigned long lastBeep = 0;
bool buzzerState = false;

// --- GLOBAL FLAGS ---
bool isOfflineMode = false;

void setup() {
  // 1. Initialize Hardware
  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  pinMode(RELAY3_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);
  digitalWrite(RELAY3_PIN, HIGH);
  digitalWrite(BUZZER_PIN, LOW);

  Serial.begin(115200);

  Wire.begin();
  lcd.begin(16, 2);
  lcd.backlight();

  dht.begin();

  strip.begin();
  strip.show();
  strip.setBrightness(BRIGHTNESS);

  // 2. Intro Sequence
  lcd.setCursor(0, 0);
  lcd.print("AromaSync");
  lcd.setCursor(0, 1);
  lcd.print("by SerenTech");
  delay(1000);

  // 3. CONNECTION SEQUENCE (60 Seconds Timeout)
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting...");

  Serial.println("\n--- SYSTEM STARTUP ---");
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);

  WiFi.begin(ssid, pass);
  Blynk.config(BLYNK_AUTH_TOKEN);

  unsigned long startAttemptTime = millis();
  bool connectedSuccess = false;
  bool wifiConnectedFlag = false;

  while (millis() - startAttemptTime < 60000) {
    if (WiFi.status() == WL_CONNECTED) {
      if (!wifiConnectedFlag) {
        wifiConnectedFlag = true;
        Serial.println();
        Serial.println(">> WiFi Connected to " + String(ssid));
        Serial.println(">> Now attempting to connect to Blynk Server...");
        Serial.print("   Please wait");
        lcd.setCursor(0, 1);
        lcd.print("WiFi OK,Blynk...");
      }

      if (!Blynk.connected()) {
        Blynk.connect(1000);
        Serial.print(".");
      } else {
        Serial.println();
        Serial.println(">> Blynk Connected Successfully!");
        connectedSuccess = true;
        break;
      }
    } else {
      Serial.print(".");
      delay(500);
    }
  }
  Serial.println();

  // 4. Determine Mode based on Connection Result
  lcd.clear();
  lcd.setCursor(0, 0);

  if (connectedSuccess) {
    isOfflineMode = false;
    relayState = 3;
    autoMode = true;
    Serial.println(">> MODE: ONLINE (Full Features Active)");
    lcd.print("System Online");
    lcd.setCursor(0, 1);
    lcd.print("Auto Mode ON");
    configTime(7 * 3600, 0, "pool.ntp.org");
  } else {
    isOfflineMode = true;
    relayState = 0;
    autoMode = false;
    Serial.println(">> TIMEOUT REACHED (60s)!");
    Serial.println(">> MODE: OFFLINE");
    lcd.print("Connection Fail");
    lcd.setCursor(0, 1);
    lcd.print("Offline Mode");
  }

  delay(2000);
  lcd.clear();
}

// --- BLYNK HANDLER FOR ZeRGBa (V5) ---
BLYNK_WRITE(V5) {
  // ZeRGBa set to MERGE mode sending 3 values (R, G, B)
  r = param[0].asInt();
  g = param[1].asInt();
  b = param[2].asInt();

  // Activate manual mode so color loop() doesn't override this color
  manualColorMode = true;

  // Directly apply color
  strip.fill(strip.Color(r, g, b));
  strip.show();
}

// Blynk V4 Handler (Change Mode)
BLYNK_WRITE(V4) {
  int value = param.asInt();
  relayState = value;

  // If user changes mode, turn off manual color mode ZeRGBa
  manualColorMode = false;

  if (value == 0) { // OFF
    digitalWrite(RELAY1_PIN, HIGH);
    digitalWrite(RELAY2_PIN, HIGH);
    autoMode = false;
  } else if (value == 1) { // FOCUS
    digitalWrite(RELAY1_PIN, LOW);
    digitalWrite(RELAY2_PIN, HIGH);
    autoMode = false;
  } else if (value == 2) { // RELAX
    digitalWrite(RELAY1_PIN, HIGH);
    digitalWrite(RELAY2_PIN, LOW);
    autoMode = false;
  } else if (value == 3) { // AUTO
    autoMode = true;
  }

  manualOverrideStart = millis();
  needsLCDUpdate = true;
}

void loop() {
  unsigned long currentMillis = millis();

  // --- 1. WIFI & BLYNK RUN ---
  if (!isOfflineMode) {
    if (WiFi.status() == WL_CONNECTED) {
      Blynk.run();
    }
  }

  // --- 2. AUTO MODE LOGIC ---
  if (!isOfflineMode && autoMode && relayState == 3) {
      if (currentMillis - manualOverrideStart >= MANUAL_OVERRIDE_DURATION && !autoMode) {
        autoMode = true;
        relayState = 3;
        needsLCDUpdate = true;
        manualColorMode = false; // Reset manual color if back to auto
      }

      if (water_value != 0 && water_value2 != 0) {
        struct tm timeinfo;
        if (getLocalTime(&timeinfo)) {
          int hour = timeinfo.tm_hour;
          int newState = 0;

          if (hour >= 8 && hour < 12) {
            newState = 1; // Focus
          } else if (hour >= 20 || hour == 0) {
            newState = 2; // Relax
          }

          if (newState == 0) {
            digitalWrite(RELAY1_PIN, HIGH);
            digitalWrite(RELAY2_PIN, HIGH);
          } else if (newState == 1) {
            digitalWrite(RELAY1_PIN, LOW);
            digitalWrite(RELAY2_PIN, HIGH);
          } else if (newState == 2) {
            digitalWrite(RELAY1_PIN, HIGH);
            digitalWrite(RELAY2_PIN, LOW);
          }
        }
      }
  }

  // --- 3. READ SENSORS ---
  if (currentMillis - lastDHTRead >= 2000) {
    lastDHTRead = currentMillis;
    float t = dht.readTemperature();
    float h = dht.readHumidity();

    if (!isnan(t) && !isnan(h)) {
        tempDeg = t;
        hum = (int)h;
    }
  }

  // Water Sensors
  water_value = analogRead(SIGNAL_PIN);
  water_value2 = analogRead(SIGNAL_PIN2);

  if (water_value == 0 || water_value2 == 0) {
    digitalWrite(RELAY1_PIN, HIGH);
    digitalWrite(RELAY2_PIN, HIGH);

    if (currentMillis - lastBeep >= 1000) {
      buzzerState = !buzzerState;
      digitalWrite(BUZZER_PIN, buzzerState ? HIGH : LOW);
      lastBeep = currentMillis;
    }

    if (needsLCDUpdate || currentMillis - lastLCDUpdate >= 1000) {
      lcd.clear();
      lcd.setCursor(0, 0);
      lcd.print("Refill Oil");
      lcd.setCursor(0, 1);
      lcd.print("Before Use");
      lastLCDUpdate = currentMillis;
      needsLCDUpdate = false;
    }
  }
  else {
    digitalWrite(BUZZER_PIN, LOW);
    buzzerState = false;

    // --- BUTTON HANDLING ---
    bool buttonState = digitalRead(BUTTON_PIN);

    if (buttonState == LOW && lastButtonState == HIGH) {
      buttonPressed = true;
      buttonPressStart = currentMillis;
    } else if (buttonState == HIGH && lastButtonState == LOW) {
      buttonPressed = false;
    }

    if (buttonPressed && buttonState == LOW && (currentMillis - buttonPressStart >= 1000)) {
      // Physical button pressed, turn off manual color mode ZeRGBa
      manualColorMode = false;

      if (isOfflineMode) {
         relayState = (relayState + 1) % 3;
      } else {
         relayState = (relayState + 1) % 4;
      }

      if (relayState == 0) {
        digitalWrite(RELAY1_PIN, HIGH);
        digitalWrite(RELAY2_PIN, HIGH);
        autoMode = false;
      } else if (relayState == 1) {
        digitalWrite(RELAY1_PIN, LOW);
        digitalWrite(RELAY2_PIN, HIGH);
        autoMode = false;
      } else if (relayState == 2) {
        digitalWrite(RELAY1_PIN, HIGH);
        digitalWrite(RELAY2_PIN, LOW);
        autoMode = false;
      } else if (relayState == 3) {
        autoMode = true;
      }

      manualOverrideStart = millis();
      buttonPressed = false;
      needsLCDUpdate = true;
    }
    lastButtonState = buttonState;

    // --- UPDATE LCD ---
    if (needsLCDUpdate || currentMillis - lastLCDUpdate >= 2000) {
      struct tm timeinfo;
      String timeStr = "--:--";

      if (!isOfflineMode && getLocalTime(&timeinfo)) {
        char timeBuffer[6];
        strftime(timeBuffer, sizeof(timeBuffer), "%H:%M", &timeinfo);
        timeStr = String(timeBuffer);
      } else {
        timeStr = "Offln";
      }

      lcd.clear();
      lcd.setCursor(0, 0);
      if (manualColorMode) lcd.print("Mode: Custom LED"); // Info if using ZeRGBa
      else if (relayState == 0) lcd.print("Mode: OFF");
      else if (relayState == 1) lcd.print("Mode: FOCUS");
      else if (relayState == 2) lcd.print("Mode: RELAX");
      else if (relayState == 3) lcd.print("Mode: AUTO");

      lcd.setCursor(0, 1);
      String displayStr = timeStr + " T:" + String((int)tempDeg) + " H:" + String(hum);
      lcd.print(displayStr);

      lastLCDUpdate = currentMillis;
      needsLCDUpdate = false;
    }
  }

  // --- LED STRIP CONTROL ---
  // Only set lights automatically IF user is NOT using ZeRGBa
  if (!manualColorMode) {
    if (relayState == 0 || relayState == 3) {
      if (currentMillis - lastColorChange >= 2000) {
        lastColorChange = currentMillis;
        isOrange = !isOrange;
      }
      strip.fill(isOrange ? strip.Color(255, 165, 0) : strip.Color(255, 255, 255));
      strip.show();
    } else if (relayState == 1) {
      strip.fill(strip.Color(0, 0, 255));
      strip.show();
    } else if (relayState == 2) {
      strip.fill(strip.Color(0, 255, 0));
      strip.show();
    }
  }
  // If manualColorMode == true, color is already set in BLYNK_WRITE(V5)

  if (!isOfflineMode && WiFi.status() == WL_CONNECTED && (currentMillis - lastBlynkSend >= 5000)) {
    lastBlynkSend = currentMillis;
    Blynk.virtualWrite(V1, tempDeg);
    Blynk.virtualWrite(V2, hum);
    Blynk.virtualWrite(V4, relayState);
  }

  delay(100);
}
